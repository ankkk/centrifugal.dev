---
title: Setting up Keycloak SSO authentication flow and connecting to Centrifugo WebSocket
tags: [centrifugo, keycloak, sso, authentication]
description: This tutorial shows how to connect to Centrifugo when using Keycloak SSO flow for user authentication. Here we build a simple demo app using React and Vite.
author: Alexander Emelin
authorTitle: Author of Centrifugo
authorImageURL: https://github.com/FZambia.png
image: /img/keycloak_sso_cover.jpg
hide_table_of_contents: false
---

![](/img/keycloak_sso_cover.jpg)

Securing user authentication and management can often be a challenging task when developing a modern application. As a result, many developers choose to delegate this responsibility to third-party identity providers, such as Okta, Auth0, or Keycloak.

In this blog post, we'll go through the process of setting up Single Sign-On (SSO) authentication using Keycloak - popular and powerful identity provider. After setting up SSO we will create React application and connect to Centrifugo using access token generated by Keycloak for our test user:

<video width="100%" loop={true} autoPlay="autoplay" muted controls="" src="/img/keycloak.mp4"></video>

<!--truncate-->

## TLDR

The integraion is possible since Centrifugo works with [standard JWT for authentication](/docs/server/authentication) and additionally [supports JSON Web Key](https://centrifugal.dev/docs/server/authentication#json-web-key-support) specification. 

Here is a final [source code](https://github.com/centrifugal/examples/tree/master/v4/keycloak_sso_auth).

## Keycloak

First, run Keycloak using the following Docker command:

```bash
docker run --rm -it -p 8080:8080 \
    -e KEYCLOAK_ADMIN=admin \
    -e KEYCLOAK_ADMIN_PASSWORD=admin \
    quay.io/keycloak/keycloak:21.0.1 start-dev
```

After starting Keycloak, go to [http://localhost:8080/admin](http://localhost:8080/admin) and login. Then perform the following tasks:

1. Create a new realm named `myrealm`.
1. Create a new client named `myclient`. Set valid redirect URIs to `http://localhost:5173/*`, and web origins as `http://localhost:5173`.
1. Create a user named `myuser` and set a password for it (in Credentials tab).

See [this guide](https://www.keycloak.org/getting-started/getting-started-docker) for additional details and illustrations of the process.

Make sure your created client is `public` (this is default) since we will request token directly from the web application.

## Centrifugo

Next, run Centrifugo using the following Docker command:

```bash
docker run --rm -it -p 8000:8000 \
    -e CENTRIFUGO_ALLOWED_ORIGINS="http://localhost:5173" \
    -e CENTRIFUGO_TOKEN_JWKS_PUBLIC_ENDPOINT="http://host.docker.internal:8080/realms/myrealm/protocol/openid-connect/certs" \
    -e CENTRIFUGO_ALLOW_USER_LIMITED_CHANNELS=true \
    -e CENTRIFUGO_ADMIN=true \
    -e CENTRIFUGO_ADMIN_SECRET=secret \
    -e CENTRIFUGO_ADMIN_PASSWORD=admin \
    centrifugo/centrifugo:v4.1.2 centrifugo
```

Some comments about environment variables used here:

* CENTRIFUGO_TOKEN_JWKS_PUBLIC_ENDPOINT allows tell Centrifugo to use JSON Web Key spec when validating tokens, we point to Keycloak's JWKS endpoint
* CENTRIFUGO_ALLOWED_ORIGINS is required since we will build Vite + React based app running on http://localhost:5173
* CENTRIFUGO_ALLOW_USER_LIMITED_CHANNELS - not required to connect, but you will see in the source code that we additionally subscribe to a user personal channel
* CENTRIFUGO_ADMIN, CENTRIFUGO_ADMIN_SECRET, CENTRIFUGO_ADMIN_PASSWORD - to enable Centrifugo admin web UI

Also note we are using `host.docker.internal` to access host port from inside the Docker network.

## React app with Vite

Now, let's create a new React app using very popular [Vite](https://vitejs.dev/) tool:

```bash
npm create vite@latest keycloak_sso_auth -- --template react
cd keycloak_sso_auth
npm install
```

Also, install the necessary additional packages for the React app:

```bash
npm install --save @react-keycloak/web centrifuge keycloak-js
```

And start the development server:

```bash
npm run dev
```

Navigate to [http://localhost:5173/](http://localhost:5173/). You should see default Vite template working, we are going to modify it a bit.

Add the following into `main.jsx`:

```javascript
import React from 'react'
import ReactDOM from 'react-dom/client'
import { ReactKeycloakProvider } from '@react-keycloak/web'
import App from './App'
import './index.css'

import Keycloak from "keycloak-js";

const keycloakClient = new Keycloak({
  url: "http://localhost:8080",
  realm: "myrealm",
  clientId: "myclient"
})

ReactDOM.createRoot(document.getElementById('root')).render(
  <ReactKeycloakProvider authClient={keycloakClient}>
    <React.StrictMode>
      <App />
    </React.StrictMode>
  </ReactKeycloakProvider>,
)
```

Note that we configured `Keycloak` instance pointing it to our Keycloak server. We also use `@react-keycloak/web` package to wrap React app into `ReactKeycloakProvider` component. It simplifies working with Keycloak by providing some useful hooks - we are using this hook below.

Our `App` component inside `App.jsx` may look like this:

```javascript
import React, { useState, useEffect } from 'react';
import logo from './assets/centrifugo.svg'
import { Centrifuge } from "centrifuge";
import { useKeycloak } from '@react-keycloak/web'
import './App.css'

function App() {
  const { keycloak, initialized } = useKeycloak()

  if (!initialized) {
    return null;
  }

  return (
    <div>
      <header>
        <p>
          SSO with Keycloak and Centrifugo
        </p>
        {keycloak.authenticated ? (
          <div>
            <p>Logged in as {keycloak.tokenParsed?.preferred_username}</p>
            <button type="button" onClick={() => keycloak.logout()}>
              Logout
            </button>
          </div>
        ) : (
          <button type="button" onClick={() => keycloak.login()}>
            Login
          </button>
        )}
      </header>
    </div >
  );
}

export default App
```

This is actually enough for SSO flow to start working! You can click on login button and make sure that it's possible to use `myuser` credentials to log into the application. And log out after that.

The only missing part is Centrifugo. We can initialize connection inside `useEffect` hook of `App` component:

```javascript
useEffect(() => {
  if (!initialized || !keycloak.authenticated) {
    return;
  }
  const centrifuge = new Centrifuge("ws://localhost:8000/connection/websocket", {
    token: keycloak.token,
    getToken: function () {
      return new Promise((resolve, reject) => {
        keycloak.updateToken(5).then(function () {
          resolve(keycloak.token);
        }).catch(function (err) {
          reject(err);
          keycloak.logout();
        });
      })
    }
  });

  centrifuge.connect();

  return () => {
    centrifuge.disconnect();
  };
}, [keycloak, initialized]);
```

The important thing here is how we configure tokens: we are using Keycloak client methods to set initial token and refresh the token when required.

I also added some extra elements to the code to make it look a bit nicer. For example, we can listen to Centriffuge client state changes and show connection indicator on the page:

```javascript
function App() {
  const [connectionState, setConnectionState] = useState("disconnected");
  const stateToEmoji = {
    "disconnected": "ðŸ”´",
    "connecting": "ðŸŸ ",
    "connected": "ðŸŸ¢"
  }
  ...

  useEffect(() => {
    ...
    centrifuge.on('state', function (ctx) {
      setConnectionState(ctx.newState);
    })
    ...

  return (
    ...
    <span className={"connectionState " + connectionState}>
      {stateToEmoji[connectionState]}
    </span>
```

You can find more details about Centrifugo client SDK API and states in [client SDK spec](/docs/transports/client_api).

If you look at source code on Github - you will also find an example of channel subscription to a user personal channel:

```javascript
function App() {
  ...
  const [publishedData, setPublishedData] = useState("");
  ...

  useEffect(() => {
    ...
    const userChannel = "#" + keycloak.tokenParsed?.sub;
    const sub = centrifuge.newSubscription(userChannel);
    sub.on("publication", function (ctx) {
      setPublishedData(JSON.stringify(ctx.data));
    }).subscribe();
    ...
```

You can now:

* test the SSO setup by logging into application
* making sure connection is successful
* try publishing a message into a user channel via the [Centrifugo Web UI](http://localhost:8000/#/actions). The published message will appear on application screen in real-time.

<video width="100%" loop={true} autoPlay="autoplay" muted controls="" src="/img/keycloak_publish.mp4"></video>

That's it! We have successfully set up Keycloak SSO authentication with Centrifugo and a React application. Again, [source code](https://github.com/centrifugal/examples/tree/master/v4/keycloak_sso_auth) is on Github.
